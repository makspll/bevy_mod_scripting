<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0.14-to-0.15 - Bevy Scripting</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Documentation for the Bevy Scripting library">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bevy Scripting</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/makspll/bevy_mod_scripting" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/makspll/bevy_mod_scripting/edit/main/docs/src/ReleaseNotes/0.14-to-0.15.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="migration-guide-013-to-014-alpha-or-014-to-015"><a class="header" href="#migration-guide-013-to-014-alpha-or-014-to-015">Migration Guide: 0.13 to 0.14-alpha or 0.14 to 0.15</a></h1>
<p>The most important changes to be aware of in this release are:</p>
<ul>
<li>
<p>BMS now uses <code>Handle&lt;ScriptAsset&gt;</code> as its principle means of referring to
scripts as opposed to the <code>ScriptId</code> that was used previously.</p>
</li>
<li>
<p>BMS exposes many more choices for deciding how scripts are associated with the
contexts in which they run.</p>
</li>
<li>
<p><code>script_id</code> is replaced with <code>script_asset</code> which now has a type of <code>Handle&lt;ScriptAsset&gt;</code>.</p>
</li>
</ul>
<h2 id="handles"><a class="header" href="#handles">Handles</a></h2>
<p>The use of handles for scripts is perhaps the biggest user-facing change. It makes BMS asset usage follow Bevy's conventions. It requires less configuration. It is more idiomatic.</p>
<h3 id="scriptcomponent-change"><a class="header" href="#scriptcomponent-change"><code>ScriptComponent</code> Change</a></h3>
<p>In prior versions, <code>ScriptComponent</code> accepted a vector of <code>ScriptId</code>s, which was a type alias for <code>Cow&lt;'static, str&gt;</code>.</p>
<pre><code class="language-diff">-pub struct ScriptComponent(pub Vec&lt;Cow&lt;'static, str&gt;&gt;);
+pub struct ScriptComponent(pub Vec&lt;Handle&lt;ScriptAsset&gt;&gt;);
</code></pre>
<p>Because <code>ScriptComponent</code> accepts handles, it is no longer necessary to store the handles somewhere to prevent the script from unloading. Nor is it necessary to configure an asset path to script id mapper.</p>
<pre><code class="language-rust ignore">ScriptComponent(vec![asset_server.load("foo.lua")])</code></pre>
<p>It is still beneficial to retain script assets in memory, for certain features to work. For example,
<code>script_asset</code> will not be able to retrieve the asset path of the script if it's not retained.</p>
<h3 id="scriptid-change"><a class="header" href="#scriptid-change"><code>ScriptId</code> Change</a></h3>
<p>The <code>ScriptId</code> has changed from being a string to being an asset ID.</p>
<pre><code class="language-diff">-type ScriptId = Cow&lt;'static, str&gt;
+type ScriptId = AssetId&lt;ScriptAsset&gt;
</code></pre>
<h3 id="no-evaluation-on-load"><a class="header" href="#no-evaluation-on-load">No Evaluation on Load</a></h3>
<p>In prior versions, BMS would immediately evaluate a <code>ScriptAsset</code> when it was loaded, and if multiple script assets were loaded, they would be evaluated in non-deterministic order. (See <a href="https://github.com/makspll/bevy_mod_scripting/issues/426">issue #426</a>.) Script assets no longer evaluate immediately. Script assets are only evaluated when their handles are added to a <code>ScriptComponent</code> or they are added to <code>StaticScripts</code>.</p>
<p>In addition when a <code>ScriptComponent</code> loads its scripts, it loads them sequentially.</p>
<h3 id="scriptassetsettings-removed"><a class="header" href="#scriptassetsettings-removed"><code>ScriptAssetSettings</code> Removed</a></h3>
<p>The <code>ScriptAssetSettings</code> has been removed. Let us address each of its fields in turn.</p>
<h4 id="script_id_mapper"><a class="header" href="#script_id_mapper"><code>script_id_mapper</code></a></h4>
<p>See <code>AssetPathToScriptIdMapper</code> section.</p>
<h4 id="extension_to_language_map-and-supported_extensions"><a class="header" href="#extension_to_language_map-and-supported_extensions"><code>extension_to_language_map</code> and <code>supported_extensions</code></a></h4>
<p>This is now represented by the <code>LanguageExtensions</code> resource, which can be configured directly during initialization</p>
<pre><code class="language-rust ignore">pub struct LanguageExtensions(HashMap&lt;&amp;'static str, Language&gt;);</code></pre>
<p>or by the <code>ConfigureScriptAssetSettings</code> trait:</p>
<pre><code class="language-rust ignore">app.add_supported_script_extensions(&amp;["p8lua"], Language::Lua);</code></pre>
<p>In addition one can configure the language of an asset when it is loaded:</p>
<pre><code class="language-rust ignore">asset_server.load_with_settings("hello.p8lua", |settings: &amp;mut ScriptSettings| {
   settings.language = Some(Language::Lua);
});</code></pre>
<p>or when it is created:</p>
<pre><code class="language-rust ignore">let content = String::from("x = 0");
let mut script = ScriptAsset::from(content);
script.language = Language::Lua;</code></pre>
<h3 id="scriptmetadata-and-scriptmetadatastore-removed"><a class="header" href="#scriptmetadata-and-scriptmetadatastore-removed"><code>ScriptMetadata</code> and <code>ScriptMetadataStore</code> Removed</a></h3>
<p>These were present to associate the previous <code>ScriptId</code> with the asset ID and language.
That is no longer necessary as the <code>ScriptAsset</code> knows its own language.</p>
<pre><code class="language-rust ignore">pub struct ScriptAsset {
    /// The body of the script
    pub content: Box&lt;[u8]&gt;,
    /// The language of the script
    pub language: Language,
}</code></pre>
<h3 id="assetpathtoscriptidmapper-removed"><a class="header" href="#assetpathtoscriptidmapper-removed"><code>AssetPathToScriptIdMapper</code> Removed</a></h3>
<p>No mapper is necessary between a script and a script ID. If you have a script handle, you have its script ID</p>
<pre><code class="language-rust ignore">let handle: Handle&lt;ScriptAsset&gt; = ...;
let script_id: ScriptId = handle.id(); // ScriptId = AssetId&lt;ScriptAsset&gt;</code></pre>
<p>and vice versa.</p>
<pre><code class="language-rust ignore">let script_id: ScriptId = ...;
let handle: Handle&lt;ScriptAsset&gt; = Handle::Weak(script_id);</code></pre>
<h2 id="contexts"><a class="header" href="#contexts">Contexts</a></h2>
<p>Choosing how scripts run is a big policy decision. Previously BMS had two options:</p>
<ul>
<li>Each script ran in its own context.</li>
<li>All scripts ran in one context.</li>
</ul>
<p>This was controlled by the <code>enable_context_sharing()</code> method on
<code>ConfigureScriptPlugin</code>. That function is now deprecated. Instead use the <code>set_context_policy</code> method:</p>
<pre><code class="language-rust ignore">app.add_plugins(LuaScriptingPlugin::default().set_context_policy(
    ContextPolicy::shared(),
));</code></pre>
<p>The reason for this change is there are many more choices than before, namely:</p>
<ul>
<li><code>ContextPolicy::shared()</code></li>
<li><code>ContextPolicy::per_script()</code></li>
<li><code>ContextPolicy::per_entity()</code></li>
<li><code>ContextPolicy::per_entity_and_script()</code></li>
</ul>
<p>See <a href="../Summary/Contexts.html">Contexts</a> for more information.</p>
<h3 id="contextkey-added"><a class="header" href="#contextkey-added"><code>ContextKey</code> Added</a></h3>
<p>Previously BMS used a <code>ScriptId</code> and sometimes an <code>Entity</code> to refer to a
context. If there was no entity then <code>Entity::from_raw(0)</code> was used. Instead BMS
now uses this <code>ContextKey</code> to look up contexts.</p>
<pre><code class="language-rust ignore">pub struct ContextKey {
    /// Entity if there is one.
    pub entity: Option&lt;Entity&gt;,
    /// Script ID if there is one.
    pub script_id: Option&lt;Handle&lt;ScriptAsset&gt;&gt;
}</code></pre>
<p>This change affects the parameters for the <code>context_pre_handling_initializers</code></p>
<pre><code class="language-diff">- context_pre_handling_initializers: vec![|script_id, entity, context| {
+ context_pre_handling_initializers: vec![|context_key, context| {
</code></pre>
<p>and <code>context_initializers</code>:</p>
<pre><code class="language-diff">- context_initializers: vec![|script_id, context| {
+ context_initializers: vec![|context_key, context| {
</code></pre>
<h2 id="recipients-changes"><a class="header" href="#recipients-changes"><code>Recipients</code> Changes</a></h2>
<p>The <code>Recipients</code> enum now looks like this:</p>
<pre><code class="language-rust ignore">#[derive(Clone, Debug)]
pub enum Recipients {
    /// The event needs to be handled by all scripts, if multiple scripts share a context, the event will be sent once per script in the context.
    AllScripts,
    /// The event is to be handled by all unique contexts, i.e. if two scripts share the same context, the event will be sent only once per the context.
    AllContexts,
    /// The event is to be handled by a specific script-entity pair
    ScriptEntity(ScriptId, Entity),
    /// the event is to be handled by a specific static script
    StaticScript(ScriptId),
}</code></pre>
<p>This aligns with how scripts are associated with contexts better.</p>
<h2 id="scriptcallbackevent-changes"><a class="header" href="#scriptcallbackevent-changes"><code>ScriptCallbackEvent</code> changes</a></h2>
<p>The language for recipients is now controlled through the <code>language</code> field of the <code>ScriptCallbackEvent</code>. This allows for more flexibility in how callbacks are handled, especially when multiple languages are involved.</p>
<p>If no language is specified, the callback will apply to all languages.</p>
<pre><code class="language-diff ignore">#[derive(Clone, Event, Debug)]
#[non_exhaustive]
pub struct ScriptCallbackEvent {
    /// The label of the callback
    pub label: CallbackLabel,
    /// The recipients of the callback
    pub recipients: Recipients,
    /// The language of the callback, if unspecified will apply to all languages
+   pub language: Option&lt;Language&gt;
    /// The arguments to the callback
    pub args: Vec&lt;ScriptValue&gt;,
    /// Whether the callback should emit a response event
    pub trigger_response: bool,
}
</code></pre>
<h2 id="bindings-changes"><a class="header" href="#bindings-changes">Bindings Changes</a></h2>
<h3 id="scriptid"><a class="header" href="#scriptid">ScriptId</a></h3>
<p><code>script_id</code> is replaced with <code>script_asset</code> which now has a type of <code>Handle&lt;ScriptAsset&gt;</code>. This means that you can no longer use a string to refer to a script, but rather you must use a handle.</p>
<p>Scripts can still access the asset path of the script using:</p>
<pre><code class="language-lua ignore">-- prints: "my_script.lua"
print(script_asset:asset_path())
</code></pre>
<h3 id="scriptattachment"><a class="header" href="#scriptattachment">ScriptAttachment</a></h3>
<p>The concept of script attachments has been introduced to describe the idea of a script instance. Previously this was muddied due to the fact script ID's were the primary way to refer to scripts. Now the instance of a script and its mapping to a context is clearer.</p>
<p>This is reflected in a brand new set of bindings:</p>
<pre><code class="language-lua ignore">-- will create backing ScriptAttachment instances, that can be used in other bindings.
local entity_script = ScriptAttachment.new_entity_script(entity, script_asset)
local static_script = ScriptAttachment.new_static_script(script_asset)
</code></pre>
<h3 id="system-builder"><a class="header" href="#system-builder">System Builder</a></h3>
<p>the system builder no longer accepts script id's as parameters. Instead it accepts script attachments</p>
<pre><code class="language-diff lua">-system_builder("my_callback", "this_script_id.lua")
+system_builder("my_callback", ScriptAttachment.new_static_script(script_asset))
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ReleaseNotes/guides.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ReleaseNotes/0.15.0.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ReleaseNotes/guides.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ReleaseNotes/0.15.0.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../multi-code-block.js"></script>



    </div>
    </body>
</html>

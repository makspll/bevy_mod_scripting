SetCurrentLanguage language="@this_script_language"
// small budget + delay in script == transition one state per frame
InstallPlugin nanoseconds_budget=1000000
SetupHandler OnTest=null, Update=null
SetupHandler OnTestPostUpdate=null, PostUpdate=null
SetupHandler Last=null, OnTestLast=null
FinalizeApp

// trigger load, in the same frame context is marked as loading
LoadScriptAs as_name="@this_script", path="@this_script"
SpawnEntityWithScript name="test_entity", script="@this_script"
WaitForScriptAssetLoaded name="@this_script"
AssertContextState state="Loading", attachment="EntityScript", entity="test_entity", script="@this_script"
EmitScriptCallbackEvent emit_response=true, entity="test_entity", label="OnTest", language=null, recipients="EntityScript", script="@this_script", string_value="arg1" 
AssertNoCallbackResponsesEmitted
// TODO: when async loading is possible test this better, right now the script has to load within two frames at most
// and in this case we need more to know it's working
RunUpdateOnce
AssertContextState state="LoadedAndActive", attachment="EntityScript", entity="test_entity", script="@this_script"
// callback does happen on the first frame when loaded
AssertCallbackSuccess attachment="EntityScript", entity="test_entity", label="OnTest", script="@this_script", expect_string_value="loaded after 1 sec"

